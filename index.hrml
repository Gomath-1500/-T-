<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ê³ ìˆ˜í•™ ë¦¬í¬íŠ¸ ìƒì„±ê¸°</title>
<style>
body { font-family:sans-serif; padding:20px; }
textarea { width:100%; height:150px; margin-bottom:10px; }
input { width:100%; padding:6px; margin-bottom:10px; }
.report { margin-top:20px; padding:12px; border:1px solid #ccc; border-radius:8px; white-space:pre-line; background:#f9f9f9; }
.report:focus { outline:2px solid #4CAF50; }
.copy-btn, .all-copy-btn { margin-top:5px; cursor:pointer; padding:6px 12px; border:none; border-radius:6px; }
.copy-btn { background:#4CAF50; color:white; margin-right:10px; }
.all-copy-btn { background:#2196F3; color:white; margin-top:20px; }
</style>
</head>
<body>
<h2>ğŸ“‹ ê³ ìˆ˜í•™ ë°ì¼ë¦¬ ë¦¬í¬íŠ¸ ìƒì„±ê¸°</h2>

<p>ë°˜ëª…, ì§„ë„, ê³¼ì œ, í…ŒìŠ¤íŠ¸ ë²”ìœ„, í•™ìƒ ì •ë³´ë¥¼ í•œêº¼ë²ˆì— ì…ë ¥í•˜ì„¸ìš”.</p>
<textarea id="inputData" placeholder="ì˜ˆ)\në°˜ëª…: ì¤‘3T(ìˆ˜ìš©)\nì§„ë„: ê³ ë“±ëŒ€ìˆ˜ ë“±ì°¨ìˆ˜ì—´~ìˆ˜ì—´ì˜ í•©ê³¼ ì¼ë°˜í•­ì˜ ê´€ê³„\nê³¼ì œ: ë“±ì°¨ìˆ˜ì—´ Aë‹¨ê³„ ë° ì§€ìˆ˜.ë¡œê·¸í•¨ìˆ˜ ì˜¤ë‹µ ì •ë¦¬\ní…ŒìŠ¤íŠ¸ ë²”ìœ„: ë“±ì°¨ìˆ˜ì—´ ì§„ë„ ëª°ì…ìˆ˜ì—…ìœ¼ë¡œ ëŒ€ì²´\ní•™ìƒ: ì´ì¢…ì°¬ 80 65 ì§€ê°10ë¶„ ê³¼ì œë¯¸í¡, ê¹€ìœ ê²¸ ê²°ì„"></textarea>

<p>ë‹´ì„ì„ ìƒë‹˜ ì´ë¦„:</p>
<input id="teacherName" placeholder="ì˜ˆ) ë°•ìš©" />

<p>ì¶”ê°€ ìš”êµ¬ì¡°ê±´:</p>
<textarea id="extraRequest" placeholder="ì˜ˆ) ë¦¬ë·°ëŠ” ë°˜ë§ë¡œ ì‘ì„±í•´ì¤˜, ì¸ì‚¬ë§ì— íŠ¹ì • ë©˜íŠ¸ ì¶”ê°€ ë“±"></textarea>

<br>
<button onclick="generateReports()">ë¦¬í¬íŠ¸ ìƒì„±</button>

<div id="reports"></div>
<button class="all-copy-btn" onclick="copyAllReports()">ğŸ“‹ ë°˜ ì „ì²´ ë¦¬í¬íŠ¸ ë³µì‚¬í•˜ê¸°</button>

<script>
async function fetchReport(dataObj){
  try {
    const res = await fetch('https://gomath-daily-report.onrender.com/generate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(dataObj)
    });
    const data = await res.json();
    return data.report;
  } catch(e){
    console.error(e);
    return `âš ï¸ GPT ì„œë²„ ì—°ê²° ì˜¤ë¥˜: ìˆ˜ì—…ë¦¬ë·°ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.`;
  }
}

async function generateReports() {
  const input = document.getElementById('inputData').value;
  const extraRequest = document.getElementById('extraRequest').value;
  const teacherName = document.getElementById('teacherName').value;
  const lines = input.split('\n').map(l => l.trim()).filter(l => l);

  let className = '', progress = '', homework = '', testRange = '';
  let studentsRaw = [];

  lines.forEach(line => {
    if (line.startsWith('ë°˜ëª…')) className = line.split(':')[1].trim();
    else if (line.startsWith('ì§„ë„')) progress = line.split(':')[1].trim();
    else if (line.startsWith('ê³¼ì œ')) homework = line.split(':')[1].trim();
    else if (line.startsWith('í…ŒìŠ¤íŠ¸ ë²”ìœ„') || line.startsWith('í…ŒìŠ¤íŠ¸')) testRange = line.split(':')[1].trim();
    else if (line.startsWith('í•™ìƒ')) {
      const studentStr = line.split(':')[1].trim();
      studentsRaw = studentStr.split(/[,]/).map(s => s.trim());
    }
  });

  const reportsContainer = document.getElementById('reports');
  reportsContainer.innerHTML = '';

  for (let idx = 0; idx < studentsRaw.length; idx++) {
    const raw = studentsRaw[idx];
    const parts = raw.split(' ').filter(p => p.trim());
    const name = parts[0];

    let dailyScore = '';
    let weakScore = '';
    let attendance = 'ì •ìƒ';
    let attitude = 'ìš°ìˆ˜';
    let homeworkStatus = 'ì •ìƒ';

    for (let i = 1; i < parts.length; i++) {
      const token = parts[i];
      if (/^\d+$/.test(token)) {
        if (dailyScore === '') dailyScore = token;
        else weakScore = token;
      } else if (token.includes('ê²°ì„')) {
        attendance = 'ê²°ì„';
      } else if (token.includes('ì§€ê°')) {
        attendance = token;
      } else if (token.includes('ê³¼ì œ') && token.includes('ë¯¸í¡')) {
        homeworkStatus = 'ë¯¸í¡';
      } else if (token.includes('ì†Œê·¹') || token.includes('í”¼ê³¤')) {
        attitude = 'ë³´í†µ';
      }
    }

    let testLabel = 'ë°ì¼ë¦¬ í…ŒìŠ¤íŠ¸';
    if (testRange.includes('ì›”ë§')) testLabel = 'ì›”ë§ í…ŒìŠ¤íŠ¸';
    else if (testRange.includes('ì£¼ê°„')) testLabel = 'ì£¼ê°„ í…ŒìŠ¤íŠ¸';
    else if (testRange.includes('ì§„ë‹¨')) testLabel = 'ì§„ë‹¨ í…ŒìŠ¤íŠ¸';
    else if (testRange.trim() !== '') testLabel = testRange; // ë‹¤ë¥¸ ë²”ìœ„ ì…ë ¥ì‹œ ê·¸ëŒ€ë¡œ

    const fullReport = await fetchReport({
      name,
      className,
      progress,
      homework,
      testRange: testLabel,
      score: dailyScore,
      weakScore,
      extraRequest,
      teacherName,
      attendance,
      attitude,
      homeworkStatus
    });

    const div = document.createElement('div');
    div.className = 'report';
    div.contentEditable = true;
    div.textContent = fullReport;

    const btn = document.createElement('button');
    btn.className = 'copy-btn';
    btn.textContent = 'ğŸ“‹ ë³µì‚¬';
    btn.onclick = () => {
      navigator.clipboard.writeText(div.textContent).then(() => {
        alert(name + ' í•™ìƒ ë¦¬í¬íŠ¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
      });
    };

    reportsContainer.appendChild(div);
    reportsContainer.appendChild(btn);
  }
}

function copyAllReports() {
  const reportDivs = document.querySelectorAll('.report');
  let allText = '';
  reportDivs.forEach(div => { allText += div.textContent + '\n\n'; });
  navigator.clipboard.writeText(allText).then(() => {
    alert('ë°˜ ì „ì²´ ë¦¬í¬íŠ¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
  });
}
</script>
</body>
</html>
